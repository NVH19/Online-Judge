<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý kì thi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            z-index: 1000;
            background-color: #b92929;
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: top 0.3s;
        }

        header img {
            width: 40px;
            height: auto;
            background-color: #fff;
            border-radius: 5px;
        }

        header i {
            font-size: 20px;
        }

        .nav-menu {
            background-color: #ddd;
            width: 200px;
            padding: 20px;
            position: fixed;
            top: 70px;
            bottom: 0;
            left: 0;
            overflow-y: auto;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
        }

        .nav-menu ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .nav-menu ul li {
            margin-bottom: 10px;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
        }

        .nav-menu ul li a {
            text-decoration: none;
            color: #ad171c;
            display: block;
            padding: 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .nav-menu ul li a:hover {
            background-color: #ccc;
        }

        .content {
            margin-top: 60px;
            margin-left: 240px;
            padding: 20px;
        }

        #examDescription {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #examEndDate {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #manageExamContent {
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #manageExamContent h2 {
            color: #ad171c;
            margin-bottom: 15px;
        }

        #manageExamContent form {
            margin-bottom: 20px;
        }

        #manageExamContent form label {
            font-weight: bold;
        }

        #manageExamContent form input[type="text"],
        #manageExamContent form textarea,
        #manageExamContent form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #manageExamContent form button {
            padding: 10px 20px;
            background-color: #ad171c;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 10px;
            margin-right: 10px;
        }

        #manageExamContent form button:hover {
            background-color: #8c1115;
        }

        #manageExamContent input[type="file"] {
            margin-right: 10px;
        }

        #manageExamContent input[type="file"],
        #manageExamContent button[type="submit"] {
            background-color: #ad171c;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #manageExamContent input[type="file"]:hover,
        #manageExamContent button[type="submit"]:hover {
            background-color: #8c1115;
        }

        #searchInput {
            padding: 8px 10px;
            border: 1px solid #ff0000;
            border-radius: 5px;
            margin-bottom: 10px;
            margin-right: 10px;
        }

        #studentTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #studentTable th,
        #studentTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #studentTable th {
            background-color: #f2f2f2;
        }

        #studentTable tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #studentTable tbody tr:hover {
            background-color: #ddd;
        }

        .form-container {
            display: none;
            background-color: #f2f2f2;
            padding: 20px;
        }

        .form-container input[type="text"],
        .form-container input[type="number"] {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .form-container input[type="submit"] {
            background-color: #4caf50;
            color: white;
            padding: 14px 20px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .form-container input[type="submit"]:hover {
            background-color: #45a049;
        }

        .form-cancel-btn {
            background-color: #f44336;
        }

        .form-cancel-btn:hover {
            background-color: #d32f2f;
        }

        /* Định dạng nút button trong phần quản lý sinh viên */
        #manageStudentsContent button {
            background-color: #ad171c;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        #manageStudentsContent button:hover {
            background-color: #9c1418;
        }

        /* Định dạng nút submit */
        #manageStudentsContent input[type="submit"] {
            background-color: #ad171c;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Định dạng nút submit khi di chuột vào */
        #manageStudentsContent input[type="submit"]:hover {
            background-color: #9c1418;
        }

        /* CSS cho trang thống kê */
        #statisticsTable {
            margin-bottom: 20px;
        }

        #filterOptions {
            margin-bottom: 20px;
        }

        #statisticsTable table {
            width: 100%;
            border-collapse: collapse;
        }

        #statisticsTable th,
        #statisticsTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #statisticsTable th {
            background-color: #f2f2f2;
        }

        #statisticsTable tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #statisticsTable tbody tr:hover {
            background-color: #ddd;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
</head>

<body>
    <header>
        <a href="adminPage"><img src="../image/logo_ptit.png" alt="Your Logo" /></a>
        <i class="fas fa-user"></i>
    </header>

    <nav class="nav-menu">
        <ul>
            <li><a href="exam" onclick="showManageExam()">Quản lý kỳ thi</a></li>
            <li>
                <a href="qlsv">Quản lý sinh viên</a>
            </li>
            <li><a href="exampleThongKe" onclick="showStatistics()">Thống kê</a></li>
        </ul>
    </nav>

    <div class="content" id="manageExamContent">
        <h2>Tạo mới kỳ thi</h2>
        <form id="examForm">
            <label for="examName">Tên kỳ thi:</label><br />
            <input type="text" id="examName" name="nameExam" /><br />
            <label for="examDescription">Trạng thái</label><br />
            <select id="examDescription" name="examDescription">
                <!-- Thay đổi từ textarea thành select -->
                <option value="Tudo">Tự do</option>
                <option value="Theolich">Theo lịch</option>
            </select><br />
            <div class="start" style="display: none;">
                <label for="examEndDate">Ngày bắt đầu</label><br />
                <input type="date" id="examEndDate" name="date" /><br />
            </div>
            <label for="examTime">Thời gian</label><br />
            <input type="text" id="examTime" name="duration" /><br />
            <label for="questions">Số câu hỏi</label><br />
            <input type="text" id="questions" name="questions" /><br />
            <button type="submit" id="submit">Lưu kỳ thi</button>
        </form>
        <form action="" id="addQuestionsForm">
            <h2>Danh sách câu hỏi</h2>
            <div id="questionList">
                <!-- Placeholder for question list -->
            </div>
            <button type="button" onclick="addQuestion()" id="addQuestions">Thêm câu hỏi</button>
            <!-- <button type="submit" id="submitQuestions" onclick="submitExam()">Lưu đề thi</button> -->

            <button type="submit" id="submitQuestions">Lưu đề thi</button>
        </form>
        <label for="excelFileInput">
            <h2>Nhập đề thi từ file Excel</h2>
        </label>
        <input type="file" id="excelFileInput" />
        <button id="addQuestions" onclick="importQuestionsFromExcel()">Nhập từ file Excel</button>
        <div id="ExcelTable"></div>
        <h2>Xóa kỳ thi</h2>
        <form id="deleteForm">
            <label for="examNameDelete">Tên kỳ thi:</label>
            <input type="text" id="examNameDelete" name="nameExamDelete" /><br />
            <button type="submit" id="deleteExamSubmit">Xóa</button>
        </form>
    </div>
    <script>
        function showManageExam() {
            document.getElementById("manageExamContent").style.display = "block";
            document.getElementById("manageStudentsContent").style.display = "none";
            document.getElementById("statisticsContent").style.display = "none";
        }
        // Thêm thời gian bắt đầu khi admin chọn trạng thái theo lịch
        document.getElementById('examDescription').addEventListener('change', function () {
            var selectedOption = this.value;
            var startDiv = document.querySelector('.start');
            if (selectedOption === 'Theolich') {
                startDiv.style.display = 'block';
            } else {
                startDiv.style.display = 'none';
            }
        });
        // Lưu kì thi
        // document.getElementById('submit').addEventListener('click', function () {
        //     alert('Thêm kì thi mới thành công!');
        //     window.location.href = 'main.html';
        // });
        var canAddQuestion = false;
        document.getElementById("examForm").addEventListener("submit", function (event) {
            event.preventDefault();

            const nameExam = document.getElementById("examName").value;
            const duration = document.getElementById("examTime").value;
            const selectElement = document.getElementById("examDescription");
            const selectedValue = selectElement.value;
            const questions = document.getElementById("questions").value;
            let date = "null";
            if (selectedValue === "Theolich") {
                {
                    date = document.getElementById("examEndDate").value;
                }
            }
            // Gửi yêu cầu POST đến API
            if (!nameExam || !duration || !date || !questions) {
                alert('Vui lòng điền đầy đủ thông tin kì thi!');
            }
            else {
                fetch('http://localhost:8081/addExam', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nameExam: nameExam, duration: duration, date: date, questions: questions })
                })
                    .then(response => {
                        return response.json();
                    })
                    .then(data => {
                        if (data.status != 200) {
                            alert(data.message);
                        } else {
                            canAddQuestion = true;
                            // console.log(canAddQuestion);
                            alert("Thêm kỳ thi thành công! Vui lòng thêm câu hỏi!");

                        }
                    })
                    .catch(error => {

                    });
            }
        });
        // console.log(canAddQuestion);
        // if (canAddQuestion) {
        //     document.getElementById("addQuestions").removeAttribute("disabled");
        // }
        var questionCounter = 1;

        function addQuestion() {
            var questionList = document.getElementById("questionList");
            var questionDiv = document.createElement("div");
            questionDiv.classList.add("question");
            questionDiv.innerHTML =
                '<label for="question' +
                questionCounter +
                '">Câu hỏi ' +
                questionCounter +
                ":</label><br>" +
                '<input type="text" id="question' +
                questionCounter +
                '" name="question' +
                questionCounter +
                '"><br>' +
                '<label for="answer' +
                questionCounter +
                'A">Đáp án A:</label><br>' +
                '<input type="text" id="answer' +
                questionCounter +
                'A" name="answer' +
                questionCounter +
                "A" +
                '"><br>' +
                '<label for="answer' +
                questionCounter +
                'B">Đáp án B:</label><br>' +
                '<input type="text" id="answer' +
                questionCounter +
                'B" name="answer' +
                questionCounter +
                "B" +
                '"><br>' +
                '<label for="answer' +
                questionCounter +
                'C">Đáp án C:</label><br>' +
                '<input type="text" id="answer' +
                questionCounter +
                'C" name="answer' +
                questionCounter +
                "C" +
                '"><br>' +
                '<label for="answer' +
                questionCounter +
                'D">Đáp án D:</label><br>' +
                '<input type="text" id="answer' +
                questionCounter +
                'D" name="answer' +
                questionCounter +
                "D" +
                '"><br>' +
                '<label for="correctAnswer' +
                questionCounter +
                '">Đáp án đúng:</label><br>' +
                '<select id="correctAnswer' +
                questionCounter +
                '" name="correctAnswer' +
                questionCounter +
                '">' +
                '<option value="A">A</option>' +
                '<option value="B">B</option>' +
                '<option value="C">C</option>' +
                '<option value="D">D</option>' +
                "</select><br>" +
                '<button type="button" onclick="deleteQuestion(this)">Xóa</button>';
            questionList.appendChild(questionDiv);
            questionCounter++;
        }


        document.getElementById("addQuestionsForm").addEventListener("submit", function (event) {
            event.preventDefault();
            // function submitExam() {
            var questionCounter = 1;
            var examName = document.getElementById("examName").value;
            var examDescription = document.getElementById("examDescription").value;
            var examEndDate = document.getElementById("examEndDate").value;

            var questions = [];
            var questionDivs = document.querySelectorAll(".question");
            questionDivs.forEach(function (questionDiv) {
                var questionText = questionDiv.querySelector(
                    'input[name^="question"]'
                ).value;
                var answerA = questionDiv.querySelector(
                    'input[name^="answer' + questionCounter + 'A"]'
                ).value;
                var answerB = questionDiv.querySelector(
                    'input[name^="answer' + questionCounter + 'B"]'
                ).value;
                var answerC = questionDiv.querySelector(
                    'input[name^="answer' + questionCounter + 'C"]'
                ).value;
                var answerD = questionDiv.querySelector(
                    'input[name^="answer' + questionCounter + 'D"]'
                ).value;
                var correctAnswer = questionDiv.querySelector(
                    'select[name^="correctAnswer' + questionCounter + '"]'
                ).value;

                var question = {
                    questionCount: questionCounter,
                    questionText: questionText,
                    answerA: answerA,
                    answerB: answerB,
                    answerC: answerC,
                    answerD: answerD,
                    correctAnswer: correctAnswer,
                };
                questions.push(question);
                questionCounter++;
                console.log("answerA", answerA);
                console.log("questionText", questionText)
            });

            var examData = {
                questions: questions,
            };

            // // Chuyển đổi đối tượng JSON thành chuỗi JSON
            var jsonData = JSON.stringify(examData);
            fetch('http://localhost:8081/addExamQuestions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(questions)
            })
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    if (data.status != 200) {
                        alert(data.message);
                    } else {
                        
                        // console.log(canAddQuestion);
                        alert("Lưu thành công đề thi!");
                        window.location.href = 'exam';
                    }
                })
                .catch(error => {

                });
            // // Lưu chuỗi JSON vào một tệp hoặc gửi đến máy chủ
            // // Ví dụ: lưu vào localStorage
            // localStorage.setItem("examPreviewData", jsonData);
            // alert(jsonData);
            // alert("Đề thi đã được lưu!");
        });

        function deleteQuestion(button) {
            var questionDiv = button.parentNode;
            questionDiv.parentNode.removeChild(questionDiv);
            questionCounter--; // Giảm số câu hỏi khi xóa
        }





        // Hàm xuất báo cáo dưới dạng PDF
        function exportToPDF() {
            // Thêm code để xuất báo cáo dưới dạng PDF ở đây
        }

        // Hàm xuất báo cáo dưới dạng Excel
        function exportToExcel() {
            // Thêm code để xuất báo cáo dưới dạng Excel ở đây
        }
        // // Hàm để đọc file Excel
        function importQuestionsFromExcel() {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Đọc dữ liệu từ sheet đầu tiên của file Excel
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Chuyển đổi dữ liệu từ sheet sang mảng JSON
                const questions = XLSX.utils.sheet_to_json(worksheet);
                // Hiển thị danh sách câu hỏi
                displayQuestions(questions);
            };

            reader.readAsArrayBuffer(file);
        }
        function displayQuestions(questions) {
            const questionList = document.getElementById('questionList');
            questionList.innerHTML = '';
            questions.forEach((question, index) => {
                var questionDiv = document.createElement("div");
                questionDiv.classList.add("question");
                questionDiv.innerHTML = `
                <label for="question${index + 1}">Câu hỏi ${index + 1}:</label><br />
                <input type = "text" id="question${index + 1}" name="question${index + 1}" value="${question['Câu hỏi']}" /><br />
                <label for="answer${index + 1}A">Đáp án A:</label><br />
                <input type="text" id="answer${index + 1}A" name="answer${index + 1}A" value="${question['Đáp án A']}" /><br />
                <label for="answer${index + 1}B">Đáp án B:</label><br />
                <input type="text" id="answer${index + 1}B" name="answer${index + 1}B" value="${question['Đáp án B']}" /><br />
                <label for="answer${index + 1}C">Đáp án C:</label><br />
                <input type="text" id="answer${index + 1}C" name="answer${index + 1}C" value="${question['Đáp án C']}" /><br />
                <label for="answer${index + 1}D">Đáp án D:</label><br />
                <input type="text" id="answer${index + 1}D" name="answer${index + 1}D" value="${question['Đáp án D']}" /><br />
                <label for="correctAnswer${index + 1}">Đáp án Đúng:</label><br />
                <select id="correctAnswer${index + 1}" name="correctAnswer${index + 1}">
                    <option value="${question['Đáp án Đúng']}">${question['Đáp án Đúng']}</option>
                </select>

                `;
                questionList.appendChild(questionDiv);
            });
        }
        document.getElementById("deleteForm").addEventListener("submit", function (event) {
            event.preventDefault();

            const nameExamDelete = document.getElementById("examNameDelete").value;
            // Gửi yêu cầu POST đến API
            if (!nameExamDelete) {
                alert('Vui lòng điền đầy tên kỳ thi muốn xóa!');
            }
            else {
                fetch('http://localhost:8081/deleteExam', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nameExamDelete: nameExamDelete })
                })
                    .then(response => {
                        return response.json();
                    })
                    .then(data => {
                        if (data.status != 200) {
                            alert(data.message);
                        } else {
                            alert("Xóa kỳ thi thành công!");

                        }
                    })
                    .catch(error => {

                    });
            }
        });
    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/jszip.js"></script>
</body>

</html>